# syntax=docker/dockerfile:1.10.0

ARG NIXL_BASE_IMAGE="nixl-h100-efa:optimized"

FROM $(NIXL_BASE_IMAGE)

# Display build summary
RUN echo "" && \
    echo "════════════════════════════════════════════════════════════════════════════" && \
    cat /opt/BUILD_SUMMARY.txt && \
    echo "════════════════════════════════════════════════════════════════════════════" && \
    echo ""

# 0. Make sure you are in the Python env you actually want to use
#    (e.g., source /opt/dynamo/venv/bin/activate, or conda activate, etc.)
ENV PIP_BREAK_SYSTEM_PACKAGES=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    UCX_WARN_UNUSED_ENV_VARS=n

# Install system dependencies (INCLUDING libzmq5)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        git \
        ca-certificates \
        libzmq5 \
        libzmq3-dev && \
    rm -rf /var/lib/apt/lists/*

    
# Force correct cuda-python version BEFORE installing tensorrt-llm/dynamo
RUN pip3 uninstall -y cuda-python cuda-bindings 2>/dev/null || true && \
    pip3 cache purge && \
    pip3 install cuda-python==12.6.0 --break-system-packages --no-cache-dir

# Verify it works before proceeding
RUN python3 -c "from cuda import cuda, cudart; print('✅ CUDA Python verified')"

# Install maturin only (don't upgrade pip in Docker)
RUN pip3 install maturin --break-system-packages

WORKDIR /opt/


RUN git clone https://github.com/ai-dynamo/dynamo.git
RUN cd /opt/dynamo && git checkout v0.4.1


RUN cd /opt/dynamo/lib/bindings/python && maturin develop

WORKDIR /opt/dynamo

RUN pip3 install -e ".[trtllm]" --break-system-packages
# Initialize PYTHONPATH if it doesn't exist
# Only append if PYTHONPATH exists, otherwise just set it

# Pick the extra you care about:
#   [trtllm], [vllm], [sglang], or [all]
# or: pip install -e ".[vllm]"
# or: pip install -e ".[all]"
# If you don't care about preserving existing PYTHONPATH
ENV PYTHONPATH="/opt/dynamo/components/backends/trtllm/src"

# Verify ZeroMQ is available
RUN ldconfig && ldconfig -p | grep libzmq.so.5

# Cleanup
RUN pip3 cache purge && \
    rm -rf /root/.cache/pip && \
    find /usr/local/lib/python3.12 -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
    rm -rf /tmp/* /var/tmp/*

CMD ["/bin/bash"]

